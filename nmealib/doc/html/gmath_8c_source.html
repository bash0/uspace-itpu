<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>NMEA: gmath.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NMEA&#160;<span id="projectnumber">0.5.3</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">gmath.c</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * NMEA library</span>
<a name="l00004"></a>00004 <span class="comment"> * URL: http://nmea.sourceforge.net</span>
<a name="l00005"></a>00005 <span class="comment"> * Author: Tim (xtimor@gmail.com)</span>
<a name="l00006"></a>00006 <span class="comment"> * Licence: http://www.gnu.org/licenses/lgpl.html</span>
<a name="l00007"></a>00007 <span class="comment"> * $Id: gmath.c 17 2008-03-11 11:56:11Z xtimor $</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> */</span>
<a name="l00010"></a>00010 
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="gmath_8h.html">nmea/gmath.h</a>&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00022"></a>00022 <span class="keywordtype">double</span> nmea_degree2radian(<span class="keywordtype">double</span> val)
<a name="l00023"></a>00023 { <span class="keywordflow">return</span> (val * <a class="code" href="gmath_8h.html#a3c641171a15e3832a0b208d0c6211cca">NMEA_PI180</a>); }
<a name="l00024"></a>00024 
<a name="l00029"></a>00029 <span class="keywordtype">double</span> nmea_radian2degree(<span class="keywordtype">double</span> val)
<a name="l00030"></a>00030 { <span class="keywordflow">return</span> (val / <a class="code" href="gmath_8h.html#a3c641171a15e3832a0b208d0c6211cca">NMEA_PI180</a>); }
<a name="l00031"></a>00031 
<a name="l00035"></a><a class="code" href="gmath_8h.html#af1ca0d6c5a26ac8fec4e3c0219db45b3">00035</a> <span class="keywordtype">double</span> nmea_ndeg2degree(<span class="keywordtype">double</span> val)
<a name="l00036"></a>00036 {
<a name="l00037"></a>00037     <span class="keywordtype">double</span> deg = ((int)(val / 100));
<a name="l00038"></a>00038     val = deg + (val - deg * 100) / 60;
<a name="l00039"></a>00039     <span class="keywordflow">return</span> val;
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00045"></a><a class="code" href="gmath_8h.html#a062bc2b58d7efdadbdf87a3a235d2fc9">00045</a> <span class="keywordtype">double</span> nmea_degree2ndeg(<span class="keywordtype">double</span> val)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047     <span class="keywordtype">double</span> int_part;
<a name="l00048"></a>00048     <span class="keywordtype">double</span> fra_part;
<a name="l00049"></a>00049     fra_part = modf(val, &amp;int_part);
<a name="l00050"></a>00050     val = int_part * 100 + fra_part * 60;
<a name="l00051"></a>00051     <span class="keywordflow">return</span> val;
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 
<a name="l00058"></a>00058 <span class="keywordtype">double</span> nmea_ndeg2radian(<span class="keywordtype">double</span> val)
<a name="l00059"></a>00059 { <span class="keywordflow">return</span> nmea_degree2radian(nmea_ndeg2degree(val)); }
<a name="l00060"></a>00060 
<a name="l00065"></a>00065 <span class="keywordtype">double</span> nmea_radian2ndeg(<span class="keywordtype">double</span> val)
<a name="l00066"></a>00066 { <span class="keywordflow">return</span> nmea_degree2ndeg(nmea_radian2degree(val)); }
<a name="l00067"></a>00067 
<a name="l00071"></a><a class="code" href="gmath_8h.html#a06643304acf31932fb3a69b4a2c2e575">00071</a> <span class="keywordtype">double</span> nmea_calc_pdop(<span class="keywordtype">double</span> hdop, <span class="keywordtype">double</span> vdop)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <span class="keywordflow">return</span> sqrt(pow(hdop, 2) + pow(vdop, 2));
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keywordtype">double</span> nmea_dop2meters(<span class="keywordtype">double</span> dop)
<a name="l00077"></a>00077 { <span class="keywordflow">return</span> (dop * <a class="code" href="gmath_8h.html#a7265e602e56b73fbc451ed8b0b49fc88">NMEA_DOP_FACTOR</a>); }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="keywordtype">double</span> nmea_meters2dop(<span class="keywordtype">double</span> meters)
<a name="l00080"></a>00080 { <span class="keywordflow">return</span> (meters / <a class="code" href="gmath_8h.html#a7265e602e56b73fbc451ed8b0b49fc88">NMEA_DOP_FACTOR</a>); }
<a name="l00081"></a>00081 
<a name="l00086"></a><a class="code" href="gmath_8h.html#a2f033e21e246354b02287e44e04c5cc5">00086</a> <span class="keywordtype">double</span> nmea_distance(
<a name="l00087"></a>00087         <span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *from_pos,    
<a name="l00088"></a>00088         <span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *to_pos       
<a name="l00089"></a>00089         )
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     <span class="keywordtype">double</span> dist = ((double)<a class="code" href="gmath_8h.html#af6771a02b058d9960856843bc20427f6">NMEA_EARTHRADIUS_M</a>) * acos(
<a name="l00092"></a>00092         sin(to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) * sin(from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) +
<a name="l00093"></a>00093         cos(to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) * cos(from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) * cos(to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> - from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>)
<a name="l00094"></a>00094         );
<a name="l00095"></a>00095     <span class="keywordflow">return</span> dist;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00105"></a><a class="code" href="gmath_8h.html#aeb935f4b386b432e1fd659f18a1544b5">00105</a> <span class="keywordtype">double</span> nmea_distance_ellipsoid(
<a name="l00106"></a>00106         <span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *from_pos,    
<a name="l00107"></a>00107         <span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *to_pos,      
<a name="l00108"></a>00108         <span class="keywordtype">double</span> *from_azimuth,       
<a name="l00109"></a>00109         <span class="keywordtype">double</span> *to_azimuth          
<a name="l00110"></a>00110         )
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112     <span class="comment">/* All variables */</span>
<a name="l00113"></a>00113     <span class="keywordtype">double</span> f, a, b, sqr_a, sqr_b;
<a name="l00114"></a>00114     <span class="keywordtype">double</span> L, phi1, phi2, U1, U2, sin_U1, sin_U2, cos_U1, cos_U2;
<a name="l00115"></a>00115     <span class="keywordtype">double</span> sigma, sin_sigma, cos_sigma, cos_2_sigmam, sqr_cos_2_sigmam, sqr_cos_alpha, lambda, sin_lambda, cos_lambda, delta_lambda;
<a name="l00116"></a>00116     <span class="keywordtype">int</span> remaining_steps; 
<a name="l00117"></a>00117     <span class="keywordtype">double</span> sqr_u, A, B, delta_sigma;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">/* Check input */</span>
<a name="l00120"></a>00120     NMEA_ASSERT(from_pos != 0);
<a name="l00121"></a>00121     NMEA_ASSERT(to_pos != 0);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="keywordflow">if</span> ((from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a> == to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) &amp;&amp; (from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> == to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>))
<a name="l00124"></a>00124     { <span class="comment">/* Identical points */</span>
<a name="l00125"></a>00125         <span class="keywordflow">if</span> ( from_azimuth != 0 )
<a name="l00126"></a>00126             *from_azimuth = 0;
<a name="l00127"></a>00127         <span class="keywordflow">if</span> ( to_azimuth != 0 )
<a name="l00128"></a>00128             *to_azimuth = 0;
<a name="l00129"></a>00129         <span class="keywordflow">return</span> 0;    
<a name="l00130"></a>00130     } <span class="comment">/* Identical points */</span>
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="comment">/* Earth geometry */</span>
<a name="l00133"></a>00133     f = <a class="code" href="gmath_8h.html#a83e99136f262c814400243d355c423e6">NMEA_EARTH_FLATTENING</a>;
<a name="l00134"></a>00134     a = <a class="code" href="gmath_8h.html#a83d3c541023d9190398c72caa8637962">NMEA_EARTH_SEMIMAJORAXIS_M</a>;
<a name="l00135"></a>00135     b = (1 - f) * a;
<a name="l00136"></a>00136     sqr_a = a * a;
<a name="l00137"></a>00137     sqr_b = b * b;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">/* Calculation */</span>
<a name="l00140"></a>00140     L = to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> - from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>;
<a name="l00141"></a>00141     phi1 = from_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>;
<a name="l00142"></a>00142     phi2 = to_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>;
<a name="l00143"></a>00143     U1 = atan((1 - f) * tan(phi1));
<a name="l00144"></a>00144     U2 = atan((1 - f) * tan(phi2));
<a name="l00145"></a>00145     sin_U1 = sin(U1);
<a name="l00146"></a>00146     sin_U2 = sin(U2);
<a name="l00147"></a>00147     cos_U1 = cos(U1);
<a name="l00148"></a>00148     cos_U2 = cos(U2);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">/* Initialize iteration */</span>
<a name="l00151"></a>00151     sigma = 0;
<a name="l00152"></a>00152     sin_sigma = sin(sigma);
<a name="l00153"></a>00153     cos_sigma = cos(sigma);
<a name="l00154"></a>00154     cos_2_sigmam = 0;
<a name="l00155"></a>00155     sqr_cos_2_sigmam = cos_2_sigmam * cos_2_sigmam;
<a name="l00156"></a>00156     sqr_cos_alpha = 0;
<a name="l00157"></a>00157     lambda = L;
<a name="l00158"></a>00158     sin_lambda = sin(lambda);                            
<a name="l00159"></a>00159     cos_lambda = cos(lambda);                       
<a name="l00160"></a>00160     delta_lambda = lambda;
<a name="l00161"></a>00161     remaining_steps = 20; 
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="keywordflow">while</span> ((delta_lambda &gt; 1e-12) &amp;&amp; (remaining_steps &gt; 0)) 
<a name="l00164"></a>00164     { <span class="comment">/* Iterate */</span>
<a name="l00165"></a>00165         <span class="comment">/* Variables */</span>
<a name="l00166"></a>00166         <span class="keywordtype">double</span> tmp1, tmp2, tan_sigma, sin_alpha, cos_alpha, C, lambda_prev; 
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         <span class="comment">/* Calculation */</span>
<a name="l00169"></a>00169         tmp1 = cos_U2 * sin_lambda;
<a name="l00170"></a>00170         tmp2 = cos_U1 * sin_U2 - sin_U1 * cos_U2 * cos_lambda;  
<a name="l00171"></a>00171         sin_sigma = sqrt(tmp1 * tmp1 + tmp2 * tmp2);                
<a name="l00172"></a>00172         cos_sigma = sin_U1 * sin_U2 + cos_U1 * cos_U2 * cos_lambda;   
<a name="l00173"></a>00173         tan_sigma = sin_sigma / cos_sigma;                  
<a name="l00174"></a>00174         sin_alpha = cos_U1 * cos_U2 * sin_lambda / sin_sigma;  
<a name="l00175"></a>00175         cos_alpha = cos(asin(sin_alpha));                 
<a name="l00176"></a>00176         sqr_cos_alpha = cos_alpha * cos_alpha;                     
<a name="l00177"></a>00177         cos_2_sigmam = cos_sigma - 2 * sin_U1 * sin_U2 / sqr_cos_alpha;
<a name="l00178"></a>00178         sqr_cos_2_sigmam = cos_2_sigmam * cos_2_sigmam; 
<a name="l00179"></a>00179         C = f / 16 * sqr_cos_alpha * (4 + f * (4 - 3 * sqr_cos_alpha));
<a name="l00180"></a>00180         lambda_prev = lambda; 
<a name="l00181"></a>00181         sigma = asin(sin_sigma); 
<a name="l00182"></a>00182         lambda = L + 
<a name="l00183"></a>00183             (1 - C) * f * sin_alpha
<a name="l00184"></a>00184             * (sigma + C * sin_sigma * (cos_2_sigmam + C * cos_sigma * (-1 + 2 * sqr_cos_2_sigmam)));                                                
<a name="l00185"></a>00185         delta_lambda = lambda_prev - lambda; 
<a name="l00186"></a>00186         <span class="keywordflow">if</span> ( delta_lambda &lt; 0 ) delta_lambda = -delta_lambda; 
<a name="l00187"></a>00187         sin_lambda = sin(lambda);
<a name="l00188"></a>00188         cos_lambda = cos(lambda);
<a name="l00189"></a>00189         remaining_steps--; 
<a name="l00190"></a>00190     }  <span class="comment">/* Iterate */</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">/* More calculation  */</span>
<a name="l00193"></a>00193     sqr_u = sqr_cos_alpha * (sqr_a - sqr_b) / sqr_b; 
<a name="l00194"></a>00194     A = 1 + sqr_u / 16384 * (4096 + sqr_u * (-768 + sqr_u * (320 - 175 * sqr_u)));
<a name="l00195"></a>00195     B = sqr_u / 1024 * (256 + sqr_u * (-128 + sqr_u * (74 - 47 * sqr_u)));
<a name="l00196"></a>00196     delta_sigma = B * sin_sigma * ( 
<a name="l00197"></a>00197         cos_2_sigmam + B / 4 * ( 
<a name="l00198"></a>00198         cos_sigma * (-1 + 2 * sqr_cos_2_sigmam) -
<a name="l00199"></a>00199         B / 6 * cos_2_sigmam * (-3 + 4 * sin_sigma * sin_sigma) * (-3 + 4 * sqr_cos_2_sigmam)
<a name="l00200"></a>00200         ));
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment">/* Calculate result */</span>
<a name="l00203"></a>00203     <span class="keywordflow">if</span> ( from_azimuth != 0 )
<a name="l00204"></a>00204     {
<a name="l00205"></a>00205         <span class="keywordtype">double</span> tan_alpha_1 = cos_U2 * sin_lambda / (cos_U1 * sin_U2 - sin_U1 * cos_U2 * cos_lambda);
<a name="l00206"></a>00206         *from_azimuth = atan(tan_alpha_1);
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208     <span class="keywordflow">if</span> ( to_azimuth != 0 )
<a name="l00209"></a>00209     {
<a name="l00210"></a>00210         <span class="keywordtype">double</span> tan_alpha_2 = cos_U1 * sin_lambda / (-sin_U1 * cos_U2 + cos_U1 * sin_U2 * cos_lambda);
<a name="l00211"></a>00211         *to_azimuth = atan(tan_alpha_2);
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">return</span> b * A * (sigma - delta_sigma);
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00220"></a><a class="code" href="gmath_8h.html#abfbbda0483fc8fe0e0f1e4393759a4b9">00220</a> <span class="keywordtype">int</span> nmea_move_horz(
<a name="l00221"></a>00221     <span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *start_pos,   
<a name="l00222"></a>00222     <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *end_pos,           
<a name="l00223"></a>00223     <span class="keywordtype">double</span> azimuth,             
<a name="l00224"></a>00224     <span class="keywordtype">double</span> distance             
<a name="l00225"></a>00225     )
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> p1 = *start_pos;
<a name="l00228"></a>00228     <span class="keywordtype">int</span> RetVal = 1;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     distance /= <a class="code" href="gmath_8h.html#a837a8521dcccea742d7813a1cf6ad565">NMEA_EARTHRADIUS_KM</a>; <span class="comment">/* Angular distance covered on earth&#39;s surface */</span>
<a name="l00231"></a>00231     azimuth = nmea_degree2radian(azimuth);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a> = asin(
<a name="l00234"></a>00234         sin(p1.<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) * cos(distance) + cos(p1.<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) * sin(distance) * cos(azimuth));
<a name="l00235"></a>00235     end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> = p1.<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> + atan2(
<a name="l00236"></a>00236         sin(azimuth) * sin(distance) * cos(p1.<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>), cos(distance) - sin(p1.<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) * sin(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>));
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <span class="keywordflow">if</span>(NMEA_POSIX(isnan)(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) || NMEA_POSIX(isnan)(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>))
<a name="l00239"></a>00239     {
<a name="l00240"></a>00240         end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a> = 0; end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> = 0;
<a name="l00241"></a>00241         RetVal = 0;
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="keywordflow">return</span> RetVal;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00253"></a><a class="code" href="gmath_8h.html#a3aa0082d3d7f10116a6c67764e1abd36">00253</a> <span class="keywordtype">int</span> nmea_move_horz_ellipsoid(
<a name="l00254"></a>00254     <span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *start_pos,   
<a name="l00255"></a>00255     <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *end_pos,           
<a name="l00256"></a>00256     <span class="keywordtype">double</span> azimuth,             
<a name="l00257"></a>00257     <span class="keywordtype">double</span> distance,            
<a name="l00258"></a>00258     <span class="keywordtype">double</span> *end_azimuth         
<a name="l00259"></a>00259     )
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="comment">/* Variables */</span>
<a name="l00262"></a>00262     <span class="keywordtype">double</span> f, a, b, sqr_a, sqr_b;
<a name="l00263"></a>00263     <span class="keywordtype">double</span> phi1, tan_U1, sin_U1, cos_U1, s, alpha1, sin_alpha1, cos_alpha1;
<a name="l00264"></a>00264     <span class="keywordtype">double</span> tan_sigma1, sigma1, sin_alpha, cos_alpha, sqr_cos_alpha, sqr_u, A, B;
<a name="l00265"></a>00265     <span class="keywordtype">double</span> sigma_initial, sigma, sigma_prev, sin_sigma, cos_sigma, cos_2_sigmam, sqr_cos_2_sigmam, delta_sigma;
<a name="l00266"></a>00266     <span class="keywordtype">int</span> remaining_steps;
<a name="l00267"></a>00267     <span class="keywordtype">double</span> tmp1, phi2, lambda, C, L;
<a name="l00268"></a>00268     
<a name="l00269"></a>00269     <span class="comment">/* Check input */</span>
<a name="l00270"></a>00270     NMEA_ASSERT(start_pos != 0);
<a name="l00271"></a>00271     NMEA_ASSERT(end_pos != 0);
<a name="l00272"></a>00272     
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (fabs(distance) &lt; 1e-12)
<a name="l00274"></a>00274     { <span class="comment">/* No move */</span>
<a name="l00275"></a>00275         *end_pos = *start_pos;
<a name="l00276"></a>00276         <span class="keywordflow">if</span> ( end_azimuth != 0 ) *end_azimuth = azimuth;
<a name="l00277"></a>00277         <span class="keywordflow">return</span> ! (NMEA_POSIX(isnan)(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) || NMEA_POSIX(isnan)(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>));
<a name="l00278"></a>00278     } <span class="comment">/* No move */</span>
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="comment">/* Earth geometry */</span>
<a name="l00281"></a>00281     f = <a class="code" href="gmath_8h.html#a83e99136f262c814400243d355c423e6">NMEA_EARTH_FLATTENING</a>;
<a name="l00282"></a>00282     a = <a class="code" href="gmath_8h.html#a83d3c541023d9190398c72caa8637962">NMEA_EARTH_SEMIMAJORAXIS_M</a>;
<a name="l00283"></a>00283     b = (1 - f) * a;
<a name="l00284"></a>00284     sqr_a = a * a;
<a name="l00285"></a>00285     sqr_b = b * b;
<a name="l00286"></a>00286     
<a name="l00287"></a>00287     <span class="comment">/* Calculation */</span>
<a name="l00288"></a>00288     phi1 = start_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>;
<a name="l00289"></a>00289     tan_U1 = (1 - f) * tan(phi1);
<a name="l00290"></a>00290     cos_U1 = 1 / sqrt(1 + tan_U1 * tan_U1);
<a name="l00291"></a>00291     sin_U1 = tan_U1 * cos_U1;
<a name="l00292"></a>00292     s = distance;
<a name="l00293"></a>00293     alpha1 = azimuth;
<a name="l00294"></a>00294     sin_alpha1 = sin(alpha1);
<a name="l00295"></a>00295     cos_alpha1 = cos(alpha1);
<a name="l00296"></a>00296     tan_sigma1 = tan_U1 / cos_alpha1;
<a name="l00297"></a>00297     sigma1 = atan2(tan_U1, cos_alpha1);
<a name="l00298"></a>00298     sin_alpha = cos_U1 * sin_alpha1;
<a name="l00299"></a>00299     sqr_cos_alpha = 1 - sin_alpha * sin_alpha;
<a name="l00300"></a>00300     cos_alpha = sqrt(sqr_cos_alpha);
<a name="l00301"></a>00301     sqr_u = sqr_cos_alpha * (sqr_a - sqr_b) / sqr_b; 
<a name="l00302"></a>00302     A = 1 + sqr_u / 16384 * (4096 + sqr_u * (-768 + sqr_u * (320 - 175 * sqr_u)));
<a name="l00303"></a>00303     B = sqr_u / 1024 * (256 + sqr_u * (-128 + sqr_u * (74 - 47 * sqr_u)));
<a name="l00304"></a>00304     
<a name="l00305"></a>00305     <span class="comment">/* Initialize iteration */</span>
<a name="l00306"></a>00306     sigma_initial = s / (b * A);
<a name="l00307"></a>00307     sigma = sigma_initial;
<a name="l00308"></a>00308     sin_sigma = sin(sigma);
<a name="l00309"></a>00309     cos_sigma = cos(sigma);
<a name="l00310"></a>00310     cos_2_sigmam = cos(2 * sigma1 + sigma);
<a name="l00311"></a>00311     sqr_cos_2_sigmam = cos_2_sigmam * cos_2_sigmam;
<a name="l00312"></a>00312     delta_sigma = 0;
<a name="l00313"></a>00313     sigma_prev = 2 * <a class="code" href="gmath_8h.html#a560bd48d0792d5239cb6bf9c873821c5">NMEA_PI</a>;
<a name="l00314"></a>00314     remaining_steps = 20;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="keywordflow">while</span> ((fabs(sigma - sigma_prev) &gt; 1e-12) &amp;&amp; (remaining_steps &gt; 0))
<a name="l00317"></a>00317     { <span class="comment">/* Iterate */</span>
<a name="l00318"></a>00318         cos_2_sigmam = cos(2 * sigma1 + sigma);
<a name="l00319"></a>00319         sqr_cos_2_sigmam = cos_2_sigmam * cos_2_sigmam;
<a name="l00320"></a>00320         sin_sigma = sin(sigma);
<a name="l00321"></a>00321         cos_sigma = cos(sigma);
<a name="l00322"></a>00322         delta_sigma = B * sin_sigma * ( 
<a name="l00323"></a>00323              cos_2_sigmam + B / 4 * ( 
<a name="l00324"></a>00324              cos_sigma * (-1 + 2 * sqr_cos_2_sigmam) - 
<a name="l00325"></a>00325              B / 6 * cos_2_sigmam * (-3 + 4 * sin_sigma * sin_sigma) * (-3 + 4 * sqr_cos_2_sigmam)
<a name="l00326"></a>00326              ));
<a name="l00327"></a>00327         sigma_prev = sigma;
<a name="l00328"></a>00328         sigma = sigma_initial + delta_sigma;
<a name="l00329"></a>00329         remaining_steps --;
<a name="l00330"></a>00330     } <span class="comment">/* Iterate */</span>
<a name="l00331"></a>00331     
<a name="l00332"></a>00332     <span class="comment">/* Calculate result */</span>
<a name="l00333"></a>00333     tmp1 = (sin_U1 * sin_sigma - cos_U1 * cos_sigma * cos_alpha1);
<a name="l00334"></a>00334     phi2 = atan2(
<a name="l00335"></a>00335             sin_U1 * cos_sigma + cos_U1 * sin_sigma * cos_alpha1,
<a name="l00336"></a>00336             (1 - f) * sqrt(sin_alpha * sin_alpha + tmp1 * tmp1)
<a name="l00337"></a>00337             );
<a name="l00338"></a>00338     lambda = atan2(
<a name="l00339"></a>00339             sin_sigma * sin_alpha1,
<a name="l00340"></a>00340             cos_U1 * cos_sigma - sin_U1 * sin_sigma * cos_alpha1
<a name="l00341"></a>00341             );
<a name="l00342"></a>00342     C = f / 16 * sqr_cos_alpha * (4 + f * (4 - 3 * sqr_cos_alpha));
<a name="l00343"></a>00343     L = lambda -
<a name="l00344"></a>00344         (1 - C) * f * sin_alpha * (
<a name="l00345"></a>00345         sigma + C * sin_sigma *
<a name="l00346"></a>00346         (cos_2_sigmam + C * cos_sigma * (-1 + 2 * sqr_cos_2_sigmam))
<a name="l00347"></a>00347         );
<a name="l00348"></a>00348     
<a name="l00349"></a>00349     <span class="comment">/* Result */</span>
<a name="l00350"></a>00350     end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> = start_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> + L;
<a name="l00351"></a>00351     end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a> = phi2;
<a name="l00352"></a>00352     <span class="keywordflow">if</span> ( end_azimuth != 0 )
<a name="l00353"></a>00353     {
<a name="l00354"></a>00354         *end_azimuth = atan2(
<a name="l00355"></a>00355             sin_alpha, -sin_U1 * sin_sigma + cos_U1 * cos_sigma * cos_alpha1
<a name="l00356"></a>00356             );
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358     <span class="keywordflow">return</span> ! (NMEA_POSIX(isnan)(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>) || NMEA_POSIX(isnan)(end_pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>));
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00364"></a><a class="code" href="gmath_8h.html#a7ae16624d96691eba1d84570e8046dd7">00364</a> <span class="keywordtype">void</span> nmea_info2pos(<span class="keyword">const</span> <a class="code" href="struct__nmea_i_n_f_o.html">nmeaINFO</a> *info, <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *pos)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a> = nmea_ndeg2radian(info-&gt;<a class="code" href="struct__nmea_i_n_f_o.html#aa7d809bffd657065584e1cad6d1ea011">lat</a>);
<a name="l00367"></a>00367     pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a> = nmea_ndeg2radian(info-&gt;<a class="code" href="struct__nmea_i_n_f_o.html#af3c4466635ab0245751e639bab174f1f">lon</a>);
<a name="l00368"></a>00368 }
<a name="l00369"></a>00369 
<a name="l00373"></a><a class="code" href="gmath_8h.html#aae885759b3bfecab406ecb8b4c0e351d">00373</a> <span class="keywordtype">void</span> nmea_pos2info(<span class="keyword">const</span> <a class="code" href="struct__nmea_p_o_s.html">nmeaPOS</a> *pos, <a class="code" href="struct__nmea_i_n_f_o.html">nmeaINFO</a> *info)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     info-&gt;<a class="code" href="struct__nmea_i_n_f_o.html#aa7d809bffd657065584e1cad6d1ea011">lat</a> = nmea_radian2ndeg(pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#a7460c3b73b0bc478183580d62ac90275">lat</a>);
<a name="l00376"></a>00376     info-&gt;<a class="code" href="struct__nmea_i_n_f_o.html#af3c4466635ab0245751e639bab174f1f">lon</a> = nmea_radian2ndeg(pos-&gt;<a class="code" href="struct__nmea_p_o_s.html#aa90c327fd33606667ceef90f636e03a0">lon</a>);
<a name="l00377"></a>00377 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Apr 13 2012 14:55:48 for NMEA by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
